メッセージング
====

登場人物：

* (S) サーバ
* (C1, C2) クライアント（複数存在）



### ( C1→ S )セッション確立 (共同編集ドキュメント新規作成)

目的：クライアントがサーバに接続し、新規ドキュメントの共同編集を開始する

伝えるべき情報

* JWT
* アカウント情報（JSON）

受信者がやること

* クライアントがJWTを提示し、サーバがその正当性を検証する
* サーバはセッションIDをクライアントに払い出す
* サーバは、JWTに記載されたドキュメント名に対応するドキュメントオブジェクトを作成し、そのクライアントをドキュメントに参加させる
* サーバは、当該クライアントのセッションIDとアカウント情報を紐付けてドキュメントオブジェクト内に保存する
* サーバはクライアントにセッションIDを返答する

備考：すでにセッションが確立されている状態で、編集対象を別ドキュメントに変更するときにもこのメッセージを利用する



### ( S → C1 )セッション確立応答

目的：接続が完了したことを、セッションIDとともに通知する

伝えるべき情報

* セッションID
* ドキュメントデータ（JSON）（この例では新規作成んので、最新ドキュメント情報はnullになる）

受信者がやること

* クライアントはセッションIDを記録する
* ドキュメントデータがnullであることから、自分が新規参加者だと知ることができるので、サーバにドキュメントをアップロードする



### ( C1→ S ) ドキュメントアップロード

目的：クライアントからサーバに編集すべきドキュメントデータをアップロードする

伝えるべき情報

* ドキュメントデータ（JSON）

受信者がやること

* サーバは、そのクライアントが属するドキュメントオブジェクトに、受信したデータを格納する
* 編集revision = 0とする



### ( C2→ S )セッション確立 (共同編集ドキュメントに参加)

目的：クライアントがサーバに接続し、既存ドキュメントの共同編集に参加

伝えるべき情報

* JWT
* ドキュメント名
* アカウント情報（JSON）

受信者がやること

* クライアントがJWTを提示し、サーバがその正当性を検証する
* サーバはセッションIDをクライアントに払い出す
* サーバはクライアントから提示されたドキュメント名に対応するドキュメントオブジェクトを取得し、そのクライアントをドキュメントに参加させる
* サーバは、当該クライアントのセッションIDとアカウント情報を紐付けてドキュメントオブジェクト内に保存する
* サーバはクライアントにセッションIDを返答する



### ( S → C2 )セッション確立応答

目的：接続が完了したことを、セッションID、ドキュメント最新状態とともに通知する

伝えるべき情報

* セッションID
* ドキュメントデータ（JSON）

受信者がやること

* セッションIDを記録する
* ドキュメントデータをアプリケーションに反映する



### ( C1, C2 → S )セッション終了

目的：クライアントがサーバとの接続を終了する

伝えるべき情報

* 終了理由（数値：通常、認証失敗、、、）

受信者がやること

* サーバは当該クライアントが編集参加中のドキュメントオブジェクトのアカウント情報から、当該クライアントのエントリを削除する
* ドキュメントオブジェクトの編集参加者数が0になったら、ドキュメントオブジェクトを破棄する



### ( S → C1, C2 ) 入退室、アカウント変更通知

目的：同じドキュメントを編集する参加者の増減やアカウント情報が変更された時に、参加者にその旨を伝える

伝えるべき情報

* セッションID（対象クライアントのセッションID）

* アカウント情報（退室したときは、ここをnullにする）

受信者がやること

* サーバは当該クライアントが参加するドキュメントオブジェクトを取得し、当該クライアント以外の編集参加中のすべてのクライアントに、当該クライアントのアカウント情報をブロードキャストする



### ( C1, C2 → S ) アカウント情報の更新

目的：クライアントのアカウント情報を変更する

伝えるべき情報

* アカウント情報（JSON）

受信者がやること

* サーバは、当該クライアントのセッションIDとアカウント情報を紐付けてドキュメントオブジェクト内に上書き保存する
* アカウント変更通知をドキュメントの編集参加者（当該クライアントを除く）にブロードキャストする



### ( C1, C2 → S ) 参加者情報の取得要求

目的：クライアントが、他の参加者のアカウント情報をサーバに要求する

伝えるべき情報

* 特になし

受信者がやること

* サーバは当該クライアントが参加するドキュメントオブジェクトを取得し、参加者すべてのアカウント情報を当該クライアントに返答する



### ( S → C1, C2 ) 参加者情報の通知

目的：ドキュメントの全参加者のアカウント情報を通知する

伝えるべき情報（一つ前のドキュメント更新と全く同じ）

* ドキュメント名
* アカウント情報（JSON）

受信者がやること

* アプリケーションにアカウント情報を渡す



### ( C1, C2 → S ) ドキュメント更新

目的：クライアントでのドキュメントの変更をサーバ上のドキュメントに反映し、参加者間で同期する

伝えるべき情報

* 変更箇所（変更箇所を特定するキーの配列をJSON化したもの）
* 操作タイプ（追加、削除、変更）
* データタイプ（文字列、数値、オブジェクト）
* 変更内容（変更箇所のvalueをJSON化したもの）

受信者がやること

* サーバは当該クライアントが参加するドキュメントオブジェクトを取得し、ドキュメントを更新する
* ドキュメントオブジェクトの編集revisionを1増加させる
* ドキュメント変更通知をドキュメントの編集参加者（当該クライアントを除く）にブロードキャストする



### ( S → C1, C2 ) ドキュメント更新通知

目的：ドキュメント変更内容を参加者に通知し、同期する

伝えるべき情報（一つ前のドキュメント更新と全く同じ）

* 変更箇所（変更箇所を特定するキーの配列をJSON化したもの）
* 操作タイプ（追加、削除、変更）
* データタイプ（文字列、数値、オブジェクト）
* 変更内容（変更箇所のvalueをJSON化したもの）

受信者がやること

* 通知内容に従ってドキュメントを更新する



### ( C1, C2 → S ) ステータス更新

目的：クライアントのステータス情報の変更をサーバに通知し、他の参加者に通知させる

伝えるべき情報

* 変更箇所（変更箇所を特定するキーの配列をJSON化したもの）
* 操作タイプ（追加、削除、変更）
* データタイプ（文字列、数値、オブジェクト）
* 変更内容（変更箇所のvalueをJSON化したもの）

受信者がやること

* サーバは当該クライアントが参加するドキュメントオブジェクトを取得し、当該クライアントのステータス情報を更新する
* ステータス変更通知をドキュメントの編集参加者（当該クライアントを除く）にブロードキャストする



### ( S → C1, C2 ) ステータス更新通知

目的：あるクライアントのステータス変更内容を参加者に通知し、同期する

伝えるべき情報（一つ前のステータス更新と全く同じ）

* 変更箇所（変更箇所を特定するキーの配列をJSON化したもの）
* 操作タイプ（追加、削除、変更）
* データタイプ（文字列、数値、オブジェクト）
* 変更内容（変更箇所のvalueをJSON化したもの）

受信者がやること

* アプリケーションに変更内容を通知する

